<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta content="hiro" name="author"/>
	<link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <title>{{ playlist_name }}</title>
    <script>
        let tracks = {{ tracks|tojson }};
        let index = 0;
        let audio = new Audio(tracks[index].url);

        function togglePlay() {
            if (audio.paused) {
                play();
            } else {
                pause();
            }
        }

function updatePlayingIcon() {
    // 既存の再生中アイコンを全て削除
    document.querySelectorAll('.playing-icon').forEach((icon) => {
        icon.remove();
    });

    // 新しい再生中アイコンを追加
    const listItem = document.getElementsByClassName('custom-list-item')[index];
    const artistElement = listItem.querySelector('.artist'); // アーティスト名の要素を取得
    const icon = document.createElement('i');
    icon.className = 'fas fa-volume-up playing-icon';

    // アーティスト名の直後に新しいアイコンを挿入
    artistElement.parentNode.insertBefore(icon, artistElement.nextSibling);
}

		function play() {
			let artworkUrl = tracks[index].image_url;
			if (!artworkUrl) {
				artworkUrl = "{{ url_for('static', filename='noimage.jpg') }}"; // アートワークがない場合のデフォルト画像
			}
			document.getElementById('playing-artwork').src = artworkUrl; // アートワークの更新
			let playingInfo =	'<span style="color: #7F7F7F;">#' + (index + 1) + ':</span>' + "<br>" + 
								'<span>' + tracks[index].name + '</span>' + "<br>" + 
								'<span style="color: #7F7F7F;">' + tracks[index].artist + '</span>';

			playingInfo += '<br><a href="/youtube?track=' + encodeURIComponent(tracks[index].name) + '&artist=' + encodeURIComponent(tracks[index].artist) + '" style="margin-top: 10px; display: inline-block;">';
			playingInfo += '<i class="fab fa-youtube fa-lg"></i><span class="play-on-youtube"> YouTube</span></a>';

			document.getElementById('playing').innerHTML = playingInfo;
			audio.play();
			audio.onended = playNext;

			updatePlayingIcon();
		}

        function pause() {
            audio.pause();
        }

        function playNext() {
            index = (index + 1) % tracks.length;
			if (tracks[index].url) {
				audio.src = tracks[index].url;
				play();
			} else {
				playNext(); // URLがNoneの場合、次の曲にスキップ
    		}
        }

        function previous() {
            index = (index - 1 + tracks.length) % tracks.length;
			if (tracks[index].url) {
				audio.src = tracks[index].url;
				play();
			} else {
				previous(); // URLがNoneの場合、前の曲にスキップ
						}
        }

		function playSpecificTrack(trackIndex) {
			index = trackIndex;
			if (tracks[index].url) {
				audio.src = tracks[index].url;
				play();
			} else {
				playNext(); // URLがNoneの場合、次の曲にスキップ
			}
		}

		document.addEventListener('DOMContentLoaded', function() {
			const playlistDropdown = document.getElementById('playlistDropdown');

			playlistDropdown.addEventListener('change', function() {
				const selectedPlaylistId = playlistDropdown.value;
				const selectedPlaylistName = playlistDropdown.options[playlistDropdown.selectedIndex].text;
				const url = `/?playlist_id=${selectedPlaylistId}&playlist_name=${encodeURIComponent(selectedPlaylistName)}`;
				window.location.href = url;
			});
		});

    </script>
</head>
<body>
	<h1>{{ playlist_name }}</h1>

	<div id="playlist-controls">
       	<select class="search-input" id="playlistDropdown">
			<option value="" disabled selected style="display:none;">-- Select a Playlist --</option>
           	<!-- プレイリスト -->
            <option value="37i9dQZEVXbINTEnbFeb8d">Viral 50 - JP</option>
            <option value="37i9dQZF1DX9vYRBO9gjDe">Japan 急上昇チャート</option>
            <option value="37i9dQZF1DXdurasRmJgpJ">令和ポップス</option>
            <option value="37i9dQZF1DXdcuhTbpro3s">1億超えヒット</option>
            <option value="37i9dQZF1DXafb0IuPwJyF">Tokyo Super Hits!</option>
            <option value="37i9dQZF1DX3diUVrKEuXr">Buzz On TV</option>
            <option value="37i9dQZF1DX9tPFwDMOaN1">K-Pop ON! Hits</option>
            <option value="37i9dQZF1DWT8aqnwgRt92">Anime Now</option>
            <option value="37i9dQZEVXbKuaTI1Z1Afx">Viral 50 - US</option>
       	</select>
	</div>

	<div id="controls">
    	<div id="playing-container">
			<img id="playing-artwork" src="{{ url_for('static', filename='noimage.jpg') }}" alt="再生中のアートワーク">
        	<div id="playing"></div>
    	</div>

    	<div id="buttons">
        	<button onclick="previous()">&#10073;&#9664;</button>
        	<button onclick="togglePlay()">&#9654;&#10074;&#10074;</button>
        	<button onclick="playNext()">&#9654;&#10073;</button>
    	</div>
	</div>

	<div class="custom-list">
    	{% for track in tracks %}
    	<div class="custom-list-item">
			<span class="custom-list-number">{{ "{: >3}".format(loop.index).replace(" ", "&nbsp;")|safe }}.</span>
			<span class="custom-list-content">
				<div class="track-info">
					<span class="track-name">{{ track.name }}</span><span class="separator"></span><span class="artist">{{ track.artist }}</span></div>
				<div class="icon-row">
        			<a href="/youtube?track={{ track.name|urlencode }}&artist={{ track.artist|urlencode }}" style="margin-right: 14px;">
           			<i class="fab fa-youtube"></i><span class="youtube-icon-caption"> YouTube</span></a>
        			{% if track.url %}
        				<a href="javascript:void(0);" onclick="playSpecificTrack({{ loop.index0 }})">
            			<i class="fab fa-spotify"></i><span class="youtube-icon-caption"> Spotify (Preview)</span></a>
        			{% else %}
        				<i class="fab fa-spotify icon-disabled"></i><span class="youtube-icon-caption"> Spotify (No Preview)</span>
        			{% endif %}
    			</div>
			</span>
    	</div>
		{% endfor %}
	</div>

<footer>
	<p>Developed by hiro <a href="https://twitter.com/jmusic_hiro" target="_blank"><i class="fab fa-twitter"></i></a> &copy;2023.
	<br>Data sourced from	<a href="https://www.youtube.com/" target="_blank"><i class="fab fa-youtube"></i> YouTube</a> and
						<a href="https://www.spotify.com" target="_blank"><i class="fab fa-spotify"></i> Spotify</a>.</p>
    <p><a href="{{ url_for('static', filename='privacy-policy-en.html') }}" target="_blank">Privacy Policy</a> | <a href="{{ url_for('static', filename='privacy-policy.html') }}" target="_blank">プライバシーポリシー</a></p>
    <p><a href="http://www.tunenest.com/">Back to Main Menu</a></p>
</footer>

</body>
</html>
