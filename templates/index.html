<!DOCTYPE html>

<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-FZ8PJFVHVW"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-FZ8PJFVHVW');
    </script>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <meta name="description" content="TuneNest: Blend Spotify & YouTube for a rich music experience. Explore previews, artist profiles, album details, and track insights.">
    <meta name="author" content="hiro">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='f_f_event_43_s16_f_event_43_0nbg.png') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='f_f_event_43_s32_f_event_43_0nbg.png') }}">
    <link rel="icon" type="image/png" sizes="64x64" href="{{ url_for('static', filename='f_f_event_43_s64_f_event_43_0nbg.png') }}">
    <title>{{ playlist_name or 'TuneNest: Discover Music' }}</title>
</head>

<body>
    <h1>{{ playlist_name }}</h1>
    <h3>{{ playlist_description|safe }}</h3>

    <div id="playlist-controls">
        <select class="search-input" id="playlistDropdown">
            <option value="" disabled selected style="display:none;">-- SELECT a PLAYLIST --</option>
            <!-- プレイリスト -->
            <option value="37i9dQZF1DWX9u2doQ8Q2L">TREND: Tokyo Rising</option>
            <option value="37i9dQZF1DWZZbpkxU5t9L">TREND: Weekly Buzz Tokyo</option>
            <option value="37i9dQZF1DX3diUVrKEuXr">TREND: Buzz On TV</option>
            <option value="37i9dQZF1DXdTxsEGukhp4">TREND: Buzz Tracker</option>
            <option value="50yOd8j0Vgohfh9JZhRqc7">TREND: TikTok Top Songs Japan</option>
            <option value="37i9dQZF1DX9vYRBO9gjDe">CHART: Spotify Japan 急上昇チャート</option>
            <option value="37i9dQZEVXbINTEnbFeb8d">CHART: Viral 50 JAPAN</option>
            <option value="37i9dQZEVXbKXQ4mDTEBXq">CHART: Top 50 JAPAN</option>
            <option value="37i9dQZF1DXafb0IuPwJyF">CHART: Tokyo Super Hits!</option>
            <option value="37i9dQZEVXbKqiTGXuCOsB">CHART: Top Songs Japan</option>
            <option value="37i9dQZF1DX3UWlNiixH0j">GENRE: Edge!</option>
            <option value="37i9dQZF1DWXQXM7agvwjO">GENRE: .ORG</option>
            <option value="37i9dQZF1DXdY5tVYFPWb2">GENRE: City Pop</option>
            <option value="37i9dQZF1DWV8IND7NkP2W">GENRE: Road Trip To Tokyo</option>
            <option value="37i9dQZF1DWWGewPG5S5oE">GENRE: Modern Jazz Japan</option>
        </select>
    </div>

    <div id="controls">

        <div id="playing-container">
            <img id="playing-artwork" src="{{ collage_filename }}" alt="Collage">
            <div id="playing"></div>
        </div>

        <div id="buttons">
            <button onclick="previous()"><i class="fas fa-step-backward"></i></button>
            <button onclick="togglePlay()"><i class="fas fa-play"></i><i class="fas fa-pause"></i></button>
            <button onclick="playNext()"><i class="fas fa-step-forward"></i></button>
        </div>

    <div class="custom-list">
        {% for track in tracks %}
        <div class="custom-list-item">
            <span class="custom-list-number">{{ "{: >3}".format(loop.index).replace(" ", "&nbsp;")|safe }}.</span>
            <span class="custom-list-content">
                <div class="track-info">
                    <span class="track-name">{{ track.name }}</span><span class="separator"></span><span class="artist">{{ track.artist }}</span></div>
                <div class="icon-row">
                    <a href="/youtube?track={{ track.name|urlencode }}&artist={{ track.artist|urlencode }}" class="youtube-link" target="_blank">
                       <i class="fab fa-youtube"></i><span class="icon-caption">Watch</span></a>
                    {% if track.url %}
                        <a href="javascript:void(0);" onclick="playSpecificTrack({{ loop.index0 }})">
                        <i class="fab fa-spotify"></i><span class="icon-caption">Preview</span></a>
                    {% else %}
                        <i class="fab fa-spotify icon-disabled"></i><span class="icon-disabled-caption">Preview</span>
                    {% endif %}

                    <!-- Info -->
                    <a href="{{ url_for('song_details', song_id=track.id) }}" target="_blank">
                    <i class="fas fa-info-circle"></i><span class="icon-caption">Info</span></a>
                </div>
            </span>
        </div>
        {% endfor %}
    </div>

<footer>
    <div class="footer-sub">
        <span>Data sourced from </span>
        <a href="https://www.youtube.com/" target="_blank" title="YouTube"><i class="fab fa-youtube"></i> YouTube</a> 
        <a href="https://www.spotify.com" target="_blank" title="Spotify"><i class="fab fa-spotify"></i> Spotify</a>
    </div>
    <div class="footer-legal">
        <a href="{{ url_for('static', filename='privacy-policy-en.html') }}" target="_blank" title="Terms of Service and Privacy Policy"></i>Terms of Service and Privacy Policy</a><br>
        <a href="{{ url_for('static', filename='privacy-policy.html') }}" target="_blank" title="利用規約とプライバシーポリシー"></i>利用規約とプライバシーポリシー</a>
    </div>
    <p class="footer-copyright">&copy; 2023  <a href="https://twitter.com/jmusic_hiro" target="_blank" title="hiro's Twitter"> hiro. <i class="fab fa-twitter"></i></a>All rights reserved.</p>
</footer>

    <script>
        let tracks = {{ tracks|tojson }};
        let index = 0;
        let audio = new Audio(tracks[index].url);

        function togglePlay() {
            if (audio.paused) {
                // 最初のトラックが再生可能かどうかをチェック
                if (tracks[index].url) {
                    play();
                } else {
                    playNext();  // 再生不可能な場合は次のトラックへ
                }
            } else {
                pause();
            }
        }

        function updatePlayingIcon() {
            // 既存の再生中アイコンを全て削除
            document.querySelectorAll('.playing-icon').forEach((icon) => {
                icon.remove();
            });

            // 新しい再生中アイコンを追加
            const listItem = document.getElementsByClassName('custom-list-item')[index];
            const artistElement = listItem.querySelector('.artist'); // アーティスト名の要素を取得
            const icon = document.createElement('i');
            icon.className = 'fas fa-volume-up playing-icon';

            // アーティスト名の直後に新しいアイコンを挿入
            artistElement.parentNode.insertBefore(icon, artistElement.nextSibling);
        }

        function play() {
            let artworkUrl = tracks[index].image_url;
            if (!artworkUrl) {
                artworkUrl = "{{ url_for('static', filename='noimage.jpg') }}"; // アートワークがない場合のデフォルト画像
            }
            document.getElementById('playing-artwork').src = artworkUrl; // アートワークの更新
            let playingInfo = '<span style="color: #7F7F7F;">#' + (index + 1) + ':</span>' + "<br>" + 
                              '<span>' + tracks[index].name + '</span>' + "<br>" + 
                              '<span style="color: #7F7F7F;">' + tracks[index].artist + '</span>' + "<br>";
        
            // YouTubeへのリンクを生成
            playingInfo += '<br><a href="/youtube?track=' + encodeURIComponent(tracks[index].name) + '&artist=' + encodeURIComponent(tracks[index].artist) + '" class="youtube-link" target="_blank" style="margin-top: 8px; display: inline-block;">';
            playingInfo += '<i class="fab fa-youtube"></i><span class="play-on-youtube">Watch</span></a>';

            // Infoへのリンクを生成
            let infoLink = `/song_details/${tracks[index].id}`;

            playingInfo += `<br><a href="${infoLink}" class="info-link" target="_blank" style="margin-top: 8px; display: inline-block;">`;
            playingInfo += '<i class="fas fa-info-circle"></i><span class="info-now-playing">Info</span></a>';

            // Tweet用のテキストを生成
            let tweetText = `${tracks[index].name} - ${tracks[index].artist}. ${tracks[index].spotify_link}`; 
        
            // Twitterへのリンクを生成
            playingInfo += '<br><a href="https://twitter.com/intent/tweet?text=' + encodeURIComponent(tweetText) + '" class="twitter-link" target="_blank" style="margin-top: 8px; display: inline-block;">';
            playingInfo += '<i class="fab fa-twitter"></i><span class="tweet-now-playing">Share</span></a>';

        
            // 最後に全てのリンクと情報をHTMLに反映
            document.getElementById('playing').innerHTML = playingInfo;

            // ここで新しく生成されたYouTubeリンクにイベントリスナーを設定
            document.querySelectorAll('.youtube-link').forEach(function(link) {
                link.addEventListener('click', function() {
                    // 一時停止関数を呼び出す
                    pause();
                });
            });
        
            audio.play();
            audio.onended = playNext;
            updatePlayingIcon();
        }

        function pause() {
            audio.pause();
        }

        function playNext(attempts = 0) {
            if (attempts >= tracks.length) {
                console.log("All tracks are unplayable. Stopping playback.");
                return;
            }
            index = (index + 1) % tracks.length;
            if (tracks[index].url) {
                audio.src = tracks[index].url;
                play();
            } else {
                playNext(attempts + 1); // URLがNoneの場合、次の曲にスキップ
            }
        }

        function previous() {
            index = (index - 1 + tracks.length) % tracks.length;
            if (tracks[index].url) {
                audio.src = tracks[index].url;
                play();
            } else {
                previous(); // URLがNoneの場合、前の曲にスキップ
                        }
        }

        function playSpecificTrack(trackIndex) {
            index = trackIndex;
            if (tracks[index].url) {
                audio.src = tracks[index].url;
                play();
            } else {
                playNext(); // URLがNoneの場合、次の曲にスキップ
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const playlistDropdown = document.getElementById('playlistDropdown');
            playlistDropdown.addEventListener('change', function() {
                const selectedPlaylistId = playlistDropdown.value;
                const selectedPlaylistName = playlistDropdown.options[playlistDropdown.selectedIndex].text;
                const url = `/?playlist_id=${selectedPlaylistId}&playlist_name=${encodeURIComponent(selectedPlaylistName)}`;
                window.location.href = url;
            });
        });

        // 新しいYouTubeリンクのクリックイベント処理
        document.addEventListener("DOMContentLoaded", function() {
            // すべてのYouTubeリンクに対してイベントリスナーを追加
            document.querySelectorAll('.youtube-link').forEach(function(link) {
                link.addEventListener('click', function() {
                // 一時停止関数を呼び出す
                pause();
                });
            });

            const COMMON_MESSAGE_BODY = "<p>Hit Play or click 'Preview' to start music!</p>";
            const message = '<span>Welcome to <strong>TuneNest</strong>!</span>' + COMMON_MESSAGE_BODY;

            document.getElementById('playing').innerHTML = message;

        });
    </script>

</body>
</html>
