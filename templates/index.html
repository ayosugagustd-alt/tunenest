<!DOCTYPE html>

<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <meta name="description" content="{{ playlist_description or 'TuneNest: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å†ç”Ÿã€ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã€ã‚¢ãƒ«ãƒãƒ ã®è©³ç´°ã€ãƒˆãƒ©ãƒƒã‚¯ã®è©³ç´°ã‚’æ¢ç´¢ã€‚' }}">
    <meta name="author" content="hiro">
    <!-- Twitter Card data -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="{{ playlist_name }}">
    <meta name="twitter:description" content="{{ playlist_description }}">
    <meta name="twitter:image" content="{{ collage_filename or url_for('static', filename='TuneNest.png') }}">
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-FZ8PJFVHVW"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-FZ8PJFVHVW');
    </script>
    <title>{{ playlist_name or 'Explore Music' }} : Spotifyãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚’è©¦è´</title>
    <script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "MusicPlaylist",
        "name": "{{ playlist_name or 'Explore Music' }}",
        "description": "{{ playlist_description or 'Explore a variety of music tracks on TuneNest.' }}",
        "numTracks": "{{ tracks|length }}",
        "track": {
            "@type": "ItemList",
            "itemListElement": [
                {% for track in tracks %}
                {
                    "@type": "ListItem",
                    "position": {{ loop.index }},
                    "item": {
                        "@type": "MusicRecording",
                        "name": "{{ track.name }}",
                        "byArtist": {
                            "@type": "MusicGroup",
                            "name": "{{ track.artist }}"
                        },
                        "image": "{{ track.image_url or url_for('static', filename='TuneNest.png') }}"
                    }
                }
                {% if not loop.last %},{% endif %}
                {% endfor %}
            ]
        }
    }
    </script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='f_f_event_43_s16_f_event_43_0nbg.png') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='f_f_event_43_s32_f_event_43_0nbg.png') }}">
    <link rel="icon" type="image/png" sizes="64x64" href="{{ url_for('static', filename='f_f_event_43_s64_f_event_43_0nbg.png') }}">
</head>
<body>
<div class="container">
    <h1>{{ playlist_name }}</h1>
    <h3>{{ playlist_description|safe }}</h3>
    {% if exceeds_max_tracks %}
        <p><i class="fas fa-exclamation-triangle"></i>{{ playlist_name }}ã¯201æ›²ä»¥ä¸Šã‚ã‚Šã¾ã™ãŒã€æœ€åˆã®200æ›²ã®ã¿è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚</p>
    {% endif %}
    <h4><a href="{{ playlist_url }}" target="_blank" rel="noopener">{{ playlist_name }}ã‚’<i class="fab fa-spotify" style="margin-right: 2px;"></i>Spotifyã§å†ç”Ÿã€‚</a></h4>

    <div id="playlist-controls" lang="ja">
        <select class="search-input" id="playlistDropdown">
            <!-- "SELECT a PLAYLIST"ã‚’æ—¥æœ¬èªã«å¤‰æ›´ -->
            <option value="" disabled selected style="display:none;">-- ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚’é¸æŠ --</option>
            <!-- "KEYWORD SEARCH"ã‚’æ—¥æœ¬èªã«å¤‰æ›´ -->
            <option value="search" class="special-option">&#x1F50D; ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ¤œç´¢</option>
            <!-- ã‚«ãƒ†ã‚´ãƒªã”ã¨ã®ã‚°ãƒ«ãƒ¼ãƒ— -->
            {% for category, items in playlists_grouped.items() %}
                <optgroup label="{{ category }}">
                    {% for id, name in items %}
                        <option value="{{ id }}">{{ name }}</option>
                    {% endfor %}
                </optgroup>
            {% endfor %}
        </select>
        <div id="searchBox" style="display:none;">
            <!-- "Enter Keyword..."ã‚’æ—¥æœ¬èªã«å¤‰æ›´ -->
            <input type="text" class="search-input" id="keyword" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›â€¦â€¦" autocomplete="off">
            <button id="searchButton"><i class="fas fa-search"></i></button>
        </div>
    </div>

    <div id="controls">

        <div id="playing-container">
            <img id="playing-artwork" src="{{ collage_filename }}" alt="Spotify Playlist Artwork" loading="lazy">
            <div id="playing"></div>
        </div>

        <div id="buttons">
            <button onclick="previous()"><i class="fas fa-step-backward"></i></button>
            <button onclick="togglePlay()"><i class="fas fa-play"></i><i class="fas fa-pause"></i></button>
            <button onclick="playNext()"><i class="fas fa-step-forward"></i></button>
            <!-- ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ç”¨ã®ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ -->
            <div class="slider-container">
                <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="1">
            </div>
        </div>

        {% for track in tracks %}
        <div class="custom-list-item">
            <span class="custom-list-number">{{ "{: >3}".format(loop.index).replace(" ", "&nbsp;")|safe }}.</span>
            <div class="custom-list-content">
                <div class="track-name">{{ track.name }}</div>
                <div class="artist">{{ track.artist }}</div>
                <div class="icon-row">
                    {% if track.url %}
                        <a href="javascript:void(0);" onclick="playSpecificTrack({{ loop.index0 }})">
                        <i class="fab fa-spotify" style="margin-right: 5px;"></i><span class="icon-caption">è©¦è´</span></a>
                    {% else %}
                        <i class="fab fa-spotify icon-disabled" style="margin-right: 5px;"></i><span class="icon-disabled-caption">è©¦è´</span>
                    {% endif %}

                    <!-- Info -->
                    <a href="{{ url_for('song_details', song_id=track.id) }}" target="_blank" rel="noopener">
                        <i class="fas fa-info-circle" style="margin-right: 5px; padding-top: 5px;"></i><span class="icon-caption">æƒ…å ±</span></a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
<footer>
    <p>&copy;2023 ãƒ’ãƒ­ <a href="https://twitter.com/jmusic_hiro" target="_blank" rel="noopener" title="ãƒ’ãƒ­ã®X"><i class="fa-brands fa-x-twitter"></i></a><a href="{{ url_for('static', filename='privacy-policy.html') }}" target="_blank" rel="noopener">åˆ©ç”¨è¦ç´„ã¨ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a></p>
</footer>
    <script>
        let tracks = {{ tracks|tojson }};
        let index = 0;
        let audio;

        // æœ€åˆã«æœ‰åŠ¹ãªURLã‚’è¦‹ã¤ã‘ã‚‹
        for (; index < tracks.length; index++) {
            if (tracks[index].url) {
                audio = new Audio(tracks[index].url);
                break;
            }
        }
        if (!audio) {
            console.log("No playable tracks in the playlist.");
        }

        function togglePlay() {
            if (audio.paused) {
                // æœ€åˆã®ãƒˆãƒ©ãƒƒã‚¯ãŒå†ç”Ÿå¯èƒ½ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯
                if (tracks[index].url) {
                    play();
                } else {
                    playNext();  // å†ç”Ÿä¸å¯èƒ½ãªå ´åˆã¯æ¬¡ã®ãƒˆãƒ©ãƒƒã‚¯ã¸
                }
            } else {
                pause();
            }
        }

        function updatePlayingIcon(isPlaying) {
            // æ—¢å­˜ã®å†ç”Ÿä¸­ã‚¢ã‚¤ã‚³ãƒ³ã‚’å…¨ã¦å‰Šé™¤
            document.querySelectorAll('.playing-icon').forEach((icon) => {
                icon.remove();
            });

            // æ–°ã—ã„å†ç”Ÿä¸­ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¿½åŠ 
            const listItem = document.getElementsByClassName('custom-list-item')[index];
            // ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆåã®è¦ç´ ã‚’å–å¾—
            const artistElement = listItem.querySelector('.artist');
            const icon = document.createElement('i');
            icon.className = 'fas fa-volume-up playing-icon';

            if (isPlaying) {
                icon.className = 'fas fa-volume-up playing-icon';
            } else {
                icon.className = 'fas fa-volume-up playing-icon no-blink';
            }

            // ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆåã®ç›´å¾Œã«æ–°ã—ã„ã‚¢ã‚¤ã‚³ãƒ³ã‚’æŒ¿å…¥
            artistElement.parentNode.insertBefore(icon, artistElement.nextSibling);

            // å†ç”Ÿãƒœã‚¿ãƒ³ã¨ä¸€æ™‚åœæ­¢ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¤ã‚³ãƒ³ã®è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹éƒ¨åˆ†ã‚’è¿½åŠ 
            const playIcon = document.querySelector('.fa-play');
            const pauseIcon = document.querySelector('.fa-pause');

            if (isPlaying) {
                playIcon.style.display = 'none';
                pauseIcon.style.display = 'inline-block';
            } else {
                playIcon.style.display = 'inline-block';
                pauseIcon.style.display = 'none';
            }
        }

        function play() {
            let artworkUrl = tracks[index].image_url;
            if (!artworkUrl) {
                artworkUrl = "{{ url_for('static', filename='TuneNest.png') }}";
            }
            // ã‚¢ãƒ¼ãƒˆãƒ¯ãƒ¼ã‚¯ã®æ›´æ–°
            document.getElementById('playing-artwork').src = artworkUrl;

            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®é©ç”¨
            let artworkElement = document.getElementById('playing-artwork');
            artworkElement.style.animation = 'none';  // æ—¢å­˜ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ

            setTimeout(() => {
                artworkElement.style.animation = 'bounce 0.5s ease';
            }, 0);

            let playingInfo = '<span style="color: #7F7F7F;">#' + (index + 1) + ':</span>' + "<br>" + 
                              '<span>' + tracks[index].name + '</span>' + "<br>" + 
                              '<span style="color: #7F7F7F;">' + tracks[index].artist + '</span>' + "<br>";

            // Spotifyã¸ã®ãƒªãƒ³ã‚¯ã‚’ç”Ÿæˆ
            let spotifyLink = `https://open.spotify.com/track/${tracks[index].id}`;
            playingInfo += `<br><a href="${spotifyLink}" target="_blank" rel="noopener" class="media-link" style="margin-top: 1px; display: inline-block;">`;
            playingInfo += '<i class="fab fa-spotify"></i><span class="info-now-playing">å†ç”Ÿ</span></a>';
        
            // Infoã¸ã®ãƒªãƒ³ã‚¯ã‚’ç”Ÿæˆ
            let infoLink = `/song_details/${tracks[index].id}`;

            playingInfo += `<br><a href="${infoLink}" target="_blank" rel="noopener" style="margin-top: 1px; display: inline-block;">`;
            playingInfo += '<i class="fas fa-info-circle"></i><span class="info-now-playing">æƒ…å ±</span></a>';

            // æœ€å¾Œã«å…¨ã¦ã®ãƒªãƒ³ã‚¯ã¨æƒ…å ±ã‚’HTMLã«åæ˜ 
            document.getElementById('playing').innerHTML = playingInfo;

            // ã“ã“ã§æ–°ã—ãç”Ÿæˆã•ã‚ŒãŸYouTubeã¨Spotify(å†ç”Ÿ)ã®ãƒªãƒ³ã‚¯ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
            document.querySelectorAll('.media-link').forEach(function(link) {
                link.addEventListener('click', function() {
                    // ä¸€æ™‚åœæ­¢é–¢æ•°ã‚’å‘¼ã³å‡ºã™
                    pause();
                });
            });
        
            // éŸ³é‡ã‚’0ã«è¨­å®šã—ã¦å†ç”Ÿã‚’é–‹å§‹
            audio.volume = 0;
            audio.play();

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¨­å®šã—ãŸæœ€å¤§ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚’å–å¾—
            let maxVolume = volumeSlider.value;

            // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³å‡¦ç†
            let fadeInterval = setInterval(function() {
                // éŸ³é‡ã‚’å¾ã€…ã«ä¸Šã’ã‚‹ãŒã€ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šã®æœ€å¤§ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚’è¶…ãˆãªã„
                if (audio.volume < maxVolume) {
                    audio.volume = Math.min(audio.volume + 0.02, maxVolume); // ã“ã®å€¤ã¯èª¿æ•´å¯èƒ½ã§ã™
                } else {
                    // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³å®Œäº†æ™‚ã«Intervalã‚’ã‚¯ãƒªã‚¢
                    clearInterval(fadeInterval);
                }
            }, 100); // 100ãƒŸãƒªç§’ã”ã¨ã«éŸ³é‡ã‚’ä¸Šã’ã‚‹
            audio.onended = playNext;
            updatePlayingIcon(true);
        }

        function pause() {
            audio.pause();
            updatePlayingIcon(false);  // ç‚¹æ»…ã‚’åœæ­¢
        }

        function playNext(attempts = 0) {
            if (attempts >= tracks.length) {
                console.log("All tracks are unplayable. Stopping playback.");
                return;
            }
            index = (index + 1) % tracks.length;
            if (tracks[index].url) {
                audio.src = tracks[index].url;
                play();
            } else {
                playNext(attempts + 1); // URLãŒNoneã®å ´åˆã€æ¬¡ã®æ›²ã«ã‚¹ã‚­ãƒƒãƒ—
            }
        }

        function previous() {
            index = (index - 1 + tracks.length) % tracks.length;
            if (tracks[index].url) {
                audio.src = tracks[index].url;
                play();
            } else {
                previous(); // URLãŒNoneã®å ´åˆã€å‰ã®æ›²ã«ã‚¹ã‚­ãƒƒãƒ—
                        }
        }

        function playSpecificTrack(trackIndex) {
            index = trackIndex;
            if (tracks[index].url) {
                audio.src = tracks[index].url;
                play();
            } else {
                playNext(); // URLãŒNoneã®å ´åˆã€æ¬¡ã®æ›²ã«ã‚¹ã‚­ãƒƒãƒ—
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const playlistDropdown = document.getElementById('playlistDropdown');
            const searchBox = document.getElementById('searchBox');
            const searchButton = document.getElementById('searchButton');
            const keywordInput = document.getElementById('keyword');
            // ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®è¦ç´ ã‚’å–å¾—
            const volumeSlider = document.getElementById("volumeSlider");

            // iOSãƒ‡ãƒã‚¤ã‚¹ä»¥å¤–ã®å ´åˆã«ã®ã¿ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚’è¡¨ç¤º
            if (!/iPad|iPhone|iPod/.test(navigator.userAgent) || window.MSStream) {
                volumeSlider.style.display = 'block'; // ã¾ãŸã¯ 'inline', 'inline-block' ãªã©ã€ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã«å¿œã˜ã¦
            }

            // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®å€¤ãŒå¤‰æ›´ã•ã‚ŒãŸã¨ãã«éŸ³é‡ã‚’èª¿æ•´
            volumeSlider.addEventListener("input", function() {
                audio.volume = volumeSlider.value;
            });


            playlistDropdown.addEventListener('change', function() {
                const selectedPlaylistId = playlistDropdown.value;
                if (selectedPlaylistId === 'search') {
                    searchBox.style.display = 'flex';
                } else {
                    searchBox.style.display = 'none';
                    const url = `/?playlist_id=${selectedPlaylistId}`;
                    window.location.href = url;
                }
            });

            // æ–°ã—ãè¿½åŠ : ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢ã™ã‚‹å‡¦ç†
            searchButton.addEventListener('click', async function() {
                const keyword = keywordInput.value;
                if (keyword) {
                    try {
                        const response = await fetch(`/search_playlist?keyword=${keyword}`);
                        if (response.ok) {
                            const data = await response.json();
                            const playlist_id = data.playlist_id;
                            const url = `/?playlist_id=${playlist_id}`;
                            window.location.href = url;
                        } else {
                            console.error('Search failed');
                        }
                    } catch (error) {
                        console.error('There was a problem with the fetch operation:', error);
                    }
                }
            });
        });

        // æ–°ã—ã„YouTubeã¨Spotify(å†ç”Ÿ)ã®ãƒªãƒ³ã‚¯ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†
        document.addEventListener("DOMContentLoaded", function() {
            // ã™ã¹ã¦ã®YouTubeã¨Spotify(å†ç”Ÿ)ã®ãƒªãƒ³ã‚¯ã«å¯¾ã—ã¦ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
            document.querySelectorAll('.media-link').forEach(function(link) {
                link.addEventListener('click', function() {
                // ä¸€æ™‚åœæ­¢é–¢æ•°ã‚’å‘¼ã³å‡ºã™
                pause();
                });
            });
            document.getElementById('playing').innerHTML = "<p><strong>TuneNest</strong>ğŸ¶</p>";
        });
    </script>
</div>
</body>
</html>
