<!DOCTYPE html>
<html lang="ja">
  <head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-ELP4DSW3BL"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-ELP4DSW3BL');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="format-detection" content="telephone=no">
    <meta name="description" content="{{ playlist_description or 'tunenest: Explore tracks, albums, and artists in detail.' }}">
    <meta name="google" content="notranslate"> <!-- Prevent translation -->
    <meta name="author" content="hiro">
    <!-- Twitter Card data -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="{{ playlist_name }}">
    <meta name="twitter:description" content="{{ playlist_description or 'Explore various tracks on tunenest.' }}">
    <meta name="twitter:image" content="{{ collage_filename or url_for('static', filename='tunenest.jpg', _external=True) }}?ver=1">
    <title>{{ playlist_name or 'Explore Music' }}</title>
    <script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "MusicPlaylist",
        "name": "{{ playlist_name or 'Explore Music' }}",
        "description": "{{ playlist_description or 'Explore various tracks on tunenest.' }}",
        "numTracks": "{{ tracks|length }}",
        "track": {
            "@type": "ItemList",
            "itemListElement": [
                {% for track in tracks %}
                {
                    "@type": "ListItem",
                    "position": {{ loop.index }},
                    "item": {
                        "@type": "MusicRecording",
                        "name": "{{ track.name }}",
                        "byArtist": {
                            "@type": "MusicGroup",
                            "name": "{{ track.artist }}"
                        },
                        "image": "{{ track.image_url or url_for('static', filename='tunenest.jpg') }}"
                    }
                }
                {% if not loop.last %},{% endif %}
                {% endfor %}
            ]
        }
    }
    </script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css', v='1.0') }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='f_f_event_43_s16_f_event_43_0nbg.png') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='f_f_event_43_s32_f_event_43_0nbg.png') }}">
    <link rel="icon" type="image/png" sizes="64x64" href="{{ url_for('static', filename='f_f_event_43_s64_f_event_43_0nbg.png') }}">
  </head>
  <body>
    <div class="container">
      {% if playlist_url %}
        <h1><a href="{{ playlist_url }}" target="_blank" rel="noopener" title="ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚’Spotifyã§è´ã">{{ playlist_name }}</a></h1>
      {% else %}
        <h1>{{ playlist_name }}</h1>
      {% endif %}
      <h4>
<!--        {% if playlist_followers %} -->
<!--          ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã®ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼æ•°: {{ playlist_followers|number_format }}äºº -->
<!--        {% endif %} -->
        {% if playlist_description %}
          <br>
            {{ playlist_description|safe }}
        {% endif %}
      </h4>
      {% if exceeds_max_tracks %}
      <h4>
        <i class="fas fa-exclamation-triangle"></i>{{ playlist_name }} has more than 501 tracks, but only the first 500 are displayed.
      </h4>
      {% endif %} 
      <div id="playlist-controls" lang="ja">
        <select class="search-input" id="playlistDropdown">
          <option value="" disabled selected style="display:none;">ğŸ”½ã“ã“ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</option>
          <!-- Grouped categories -->{% for category, items in playlists_grouped.items() %} 
          <optgroup label="&#x2022;{{ category }}">{% for id, name in items %}
            <option value="{{ id }}">&#x2022;{{ name }}</option>{% endfor %}
          </optgroup>{% endfor %} 
          <!-- <option value="searchTrack" class="special-option">&#x1F50D; æ›²ã‚’æ¤œç´¢</option> -->
          <!-- <option value="searchArtist" class="special-option">&#x1F50D; ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆã‚’æ¤œç´¢</option> -->
          <!-- <option value="searchPlaylist" class="special-option">&#x1F50D; ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚’æ¤œç´¢</option> -->
        </select>
        <div id="searchBox" style="display:none;">
          <input type="text" class="search-input" id="keyword" tabindex="0" placeholder="Track name, artist nameâ€¦" autocomplete="off">
          <button id="searchButton">
            <i class="fas fa-search"></i>
          </button>
        </div>
      </div>
      <div id="controls">
        <div id="playing-container">
          <img id="playing-artwork" src="{{ collage_filename }}" alt="Spotify Playlist Artwork" loading="lazy">
          <div id="playing">
            <h2>é•·å²¡äº®ä»‹<br>
              <span class="tunenest-logo">WORKS!!</span>
            </h2>
          </div>
        </div>
        <div class="sort-section">
          <div class="sort-option">
            <div>
              <button class="sort-button" onclick="sortTracks('bpm', 'asc')">
                <i class="fas fa-sort-up"></i>
              </button>
              <button class="sort-button" onclick="sortTracks('bpm', 'desc')">
                <i class="fas fa-sort-down"></i>
              </button>
            </div>
            <p>BPM<br>ã‚½ãƒ¼ãƒˆ</p>
          </div>
          <div class="sort-option">
            <div>
              <button class="sort-button" onclick="sortTracks('camelot', 'asc')">
                <i class="fas fa-sort-up"></i>
              </button>
              <button class="sort-button" onclick="sortTracks('camelot', 'desc')">
                <i class="fas fa-sort-down"></i>
              </button>
            </div>
            <p>
              Camelot
              <span class="tooltip">
                <i class="fas fa-info-circle"></i>
                <span class="tooltiptext">
                    Camelotã¯ã€DJãŒæ¥½æ›²ã®ã‚­ãƒ¼ã«åŸºã¥ãèª¿å’Œã®ã¨ã‚ŒãŸãƒŸãƒƒã‚¯ã‚¹ã‚’è¡Œã†ãŸã‚ã®ã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚è©³ã—ãã¯<a href="#" onclick="openCamelotWheel()">ã“ã¡ã‚‰</a>ã‚’ã”è¦§ãã ã•ã„ã€‚
                </span>
              </span>
            <br>ã‚½ãƒ¼ãƒˆ
            </p>
          </div>
<!--          <div class="sort-option"> -->
<!--            <div> -->
<!--              <button class="sort-button" onclick="sortTracks('popularity', 'desc')"> -->
<!--                <i class="fas fa-sort-up"></i> -->
<!--              </button> -->
<!--              <button class="sort-button" onclick="sortTracks('popularity', 'asc')"> -->
<!--                <i class="fas fa-sort-down"></i> -->
<!--              </button> -->
<!--            </div> -->
<!--            <p>äººæ°—åº¦ -->
<!--              <span class="tooltip"> -->
<!--                <i class="fas fa-info-circle"></i> -->
<!--                  <span class="tooltiptext"> -->
<!--                    Spotifyã®äººæ°—åº¦ã¯0ã‹ã‚‰100ã®ç¯„å›²ã§ã€100ãŒæœ€ã‚‚äººæ°—ã®é«˜ã„å€¤ã§ã™ã€‚ -->
<!--                  </span> -->
<!--              </span> -->
<!--            </p> -->
<!--          </div> -->
          <div class="sort-option">
            <div>
              <button class="sort-button" onclick="resetTracks()">
                <i class="fas fa-undo"></i>
              </button>
            </div>
            <p>ãƒªã‚»ãƒƒãƒˆ</p>
          </div>
        </div>
        <div id="buttons">
          <button onclick="previous()">
            <i class="fas fa-step-backward"></i>
          </button>
          <button onclick="togglePlay()">
            <i class="fas fa-play"></i>
            <i class="fas fa-pause"></i>
          </button>
          <button onclick="playNext()">
            <i class="fas fa-step-forward"></i>
          </button>
          <button id="repeatModeButton" class="repeat-mode-button">
            <i class="fas fa-sync"></i><span class="spotify-green">all</span>
          </button>
          <!-- Volume control slider -->
          <div>
            <input type="range" id="volumeSlider" min="0" max="0.5" step="0.01" value="0.5">
          </div>
        </div>
        {% for track in tracks %}
        <div class="custom-list-item">
          <div class="track-number">{{ loop.index }}</div>
          <img src="{{ track.image_url | default(url_for('static', filename='tunenest.jpg')) }}" alt="Artwork" class="track-artwork">
          <div class="track-info">
            <div class="track-details">
              <div class="track-name">
                <a href="{{ url_for('song_details', song_id=track.id) }}" target="_blank" rel="noopener" title="æ›²ã®è©³ç´°ã‚’è¦‹ã‚‹">
                  {{ track.name }}
                </a>
              </div>
              <div class="artist">
                <a href="{{ url_for('artist_details', artist_id=track.artist_id) }}" target="_blank" rel="noopener" title="ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆã®è©³ç´°ã‚’è¦‹ã‚‹">
                  {{ track.artist }}
                </a>
              </div>
            </div>
            <div class="icon-row">
              <span class="tempo-value">{{ '{:0.0f}'.format(track.tempo|float) }} BPM</span>
              <span class="camelot-info">{{ "{: >3}".format(track.camelot_key_signature) }}</span>
              <!-- <span class="track-popularity">{{ '{: >3}'.format(track.popularity) }}%</span> -->
              {% if track.url %}
                <a href="javascript:void(0);" onclick="playSpecificTrack({{ loop.index0 }})">
                  <span class="icon-caption">è©¦è´</span>
                </a>
              {% else %}
                <span class="icon-disabled-caption">è©¦è´</span>
              {% endif %}
              <a href="https://open.spotify.com/track/{{ track.id }}" target="_blank" rel="noopener" title="Spotifyã§è´ã">
                <span class="icon-caption">ãƒ•ãƒ«</span>
              </a>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
      <footer>
        <p>&copy;2023 ãƒ’ãƒ­
          <a href="https://twitter.com/jmusic_hiro" target="_blank" rel="noopener" title="hiro's X">
            <i class="fab fa-x-twitter"></i>
          </a>
          <a href="{{ url_for('static', filename='privacy-policy.html') }}" target="_blank" rel="noopener">ã”åˆ©ç”¨ã«ã‚ãŸã£ã¦ | ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a>
        </p>
      </footer>

      <script>
        let repeatMode = 'all'; // 'all' ã¾ãŸã¯ 'single' ã‚’æ ¼ç´

        // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å—ã‘å–ã£ãŸãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆIDã‚’ä¿æŒ
        const defaultPlaylistId = "{{ default_playlist_id }}";

        /* Safariã‚’è­˜åˆ¥ */
        function isSafari() {
            return /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
        }

        let tracks = {{ tracks|tojson }};
        let index = 0;
        let audio;

        // æœ€åˆã«æœ‰åŠ¹ãªURLã‚’è¦‹ã¤ã‘ã‚‹
        for (; index < tracks.length; index++) {
            if (tracks[index].url) {
                audio = new Audio(tracks[index].url);
                break;
            }
        }
        if (!audio) {
            console.log("No playable tracks in the playlist.");
        }

        function togglePlay() {
            if (audio.paused) {
                // æœ€åˆã®ãƒˆãƒ©ãƒƒã‚¯ãŒå†ç”Ÿå¯èƒ½ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯
                if (tracks[index].url) {
                    play();
                } else {
                    playNext();  // å†ç”Ÿä¸å¯èƒ½ãªå ´åˆã¯æ¬¡ã®ãƒˆãƒ©ãƒƒã‚¯ã¸
                }
            } else {
                pause();
            }
        }

        function updatePlayingIcon(isPlaying) {
            const playIcon = document.querySelector('.fa-play');
            const pauseIcon = document.querySelector('.fa-pause');

            if (isPlaying) {
                playIcon.style.display = 'none';
                pauseIcon.style.display = 'inline-block';
            } else {
                playIcon.style.display = 'inline-block';
                pauseIcon.style.display = 'none';
            }
        }

        function play() {
            let artworkUrl = tracks[index].image_url;
            if (!artworkUrl) {
                artworkUrl = "{{ url_for('static', filename='tunenest.jpg') }}";
            }
            // ã‚¢ãƒ¼ãƒˆãƒ¯ãƒ¼ã‚¯ã®æ›´æ–°
            document.getElementById('playing-artwork').src = artworkUrl;

            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®é©ç”¨
            let artworkElement = document.getElementById('playing-artwork');

            artworkElement.onload = () => {
                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®é©ç”¨
                artworkElement.style.animation = 'none';  // æ—¢å­˜ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
                setTimeout(() => {
                    artworkElement.style.removeProperty('animation');
                    artworkElement.offsetWidth; // å¼·åˆ¶å†æç”»
                    artworkElement.style.animation = 'bounce 0.5s ease';
                }, 0);
            };
            artworkElement.src = artworkUrl;

            // ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›´æ–°ã™ã‚‹
            const currentIndex = (index + 1); // å†ç”Ÿä¸­ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ç•ªå·
            const currentTrackName = tracks[index].name; // å†ç”Ÿä¸­ã®ãƒˆãƒ©ãƒƒã‚¯å
            const currentArtistName = tracks[index].artist; // å†ç”Ÿä¸­ã®ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆå
            const currentTempo = tracks[index].tempo; // å†ç”Ÿä¸­ã®ãƒˆãƒ©ãƒƒã‚¯ã®ãƒ†ãƒ³ãƒ
            const formattedTempo = currentTempo.toFixed(0); // ãƒ†ãƒ³ãƒã‚’å°æ•°ç‚¹ä»¥ä¸‹0æ¡ã§ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
            // ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¿ã‚°ã‚’æ›´æ–°
            document.title = `#${currentIndex}: ${currentTrackName} - ${currentArtistName}`;
            // ã“ã“ã¾ã§

            let camelotColor = tracks[index].camelot_color;  // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å—ã‘å–ã£ãŸã‚«ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰

            let playingInfo = `
                <span>#${index + 1}:</span><br>
                <span><strong>
                    <a href="/song_details/${tracks[index].id}" target="_blank" rel="noopener" title="æ¥½æ›²ã®è©³ç´°ã‚’è¦‹ã‚‹">${tracks[index].name}</a>
                </strong></span><br>
                <span>
                    <a href="/artist/${tracks[index].artist_id}" target="_blank" rel="noopener" title="ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆã®è©³ç´°ã‚’è¦‹ã‚‹">${tracks[index].artist}</a>
                </span><br><br>
                <span>${formattedTempo} BPM</span><br>
                <span>Camelot</span>
                <span style="background-color: ${camelotColor}; color: #000; padding: 2px 5px; border-radius: 3px;">
                    ${tracks[index].camelot_key_signature}
                </span><!-- <br> -->
                <!-- <span>äººæ°—åº¦ ${tracks[index].popularity}%</span> -->
            `;

            // è©¦è´ãƒªãƒ³ã‚¯ã‚’ç”Ÿæˆ
            playingInfo += `<br><a href="javascript:void(0);" onclick="playSpecificTrack(${index})">è©¦è´</a>`;

            // Spotifyã¸ã®ãƒªãƒ³ã‚¯ã‚’ç”Ÿæˆ
            let spotifyLink = `https://open.spotify.com/track/${tracks[index].id}`;
            playingInfo += `<br><a href="${spotifyLink}" target="_blank" rel="noopener" title="æ¥½æ›²ã‚’Spotifyã§è´ã">ãƒ•ãƒ«</a>`;

            // æœ€å¾Œã«å…¨ã¦ã®ãƒªãƒ³ã‚¯ã¨è©³ç´°ã‚’HTMLã«åæ˜ 
            document.getElementById('playing').innerHTML = playingInfo;

            // éŸ³é‡ã‚’0.1ã«è¨­å®šã—ã¦å†ç”Ÿã‚’é–‹å§‹
            audio.volume = 0.2;
            audio.play();

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¨­å®šã—ãŸæœ€å¤§ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚’å–å¾—
            let maxVolume = volumeSlider.value;

            // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³å‡¦ç†
            let fadeInterval = setInterval(function() {
                // éŸ³é‡ã‚’å¾ã€…ã«ä¸Šã’ã‚‹ãŒã€ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šã®æœ€å¤§ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚’è¶…ãˆãªã„
                if (audio.volume < maxVolume) {
                    audio.volume = Math.min(audio.volume + (maxVolume / 20), maxVolume); // ã“ã®å€¤ã¯èª¿æ•´å¯èƒ½ã§ã™
                } else {
                    // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³å®Œäº†æ™‚ã«Intervalã‚’ã‚¯ãƒªã‚¢
                    clearInterval(fadeInterval);
                }
            }, 100); // 100ãƒŸãƒªç§’ã”ã¨ã«éŸ³é‡ã‚’ä¸Šã’ã‚‹
            audio.onended = playNext;
            updatePlayingIcon(true);
            markPlayingItem(index); // ã“ã“ã§å†ç”Ÿä¸­ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’ãƒãƒ¼ã‚¯
        }

        function pause() {
            audio.pause();
            updatePlayingIcon(false);
        }

        function playNext(attempts = 0) {
            if (attempts >= tracks.length) {
                console.log("All tracks are unplayable. Stopping playback.");
                return;
            }
            if (repeatMode === 'single') {
                // ã‚·ãƒ³ã‚°ãƒ«ãƒªãƒ”ãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰ã§ã¯åŒã˜ãƒˆãƒ©ãƒƒã‚¯ã‚’ç¹°ã‚Šè¿”ã—å†ç”Ÿã™ã‚‹
                audio.src = tracks[index].url;
                play();
            } else {
                // é€šå¸¸ã¯æ¬¡ã®ãƒˆãƒ©ãƒƒã‚¯ã¸é€²ã‚€
                index = (index + 1) % tracks.length;
                if (tracks[index].url) {
                    audio.src = tracks[index].url;
                    play();
                } else {
                    // URLãŒç„¡ã„å ´åˆã¯æ¬¡ã®æ›²ã¸ã‚¹ã‚­ãƒƒãƒ—
                    playNext(attempts + 1);
                }
            }
        }

        function previous() {
            index = (index - 1 + tracks.length) % tracks.length;
            if (tracks[index].url) {
                audio.src = tracks[index].url;
                play();
            } else {
                previous(); // URLãŒNoneã®å ´åˆã€å‰ã®æ›²ã«ã‚¹ã‚­ãƒƒãƒ—
                        }
        }

        function playSpecificTrack(trackIndex) {
            index = trackIndex;
            if (tracks[index].url) {
                audio.src = tracks[index].url;
                play();
            } else {
                playNext(); // URLãŒNoneã®å ´åˆã€æ¬¡ã®æ›²ã«ã‚¹ã‚­ãƒƒãƒ—
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const playlistDropdown = document.getElementById('playlistDropdown');
            const searchBox = document.getElementById('searchBox');
            const searchButton = document.getElementById('searchButton');
            const keywordInput = document.getElementById('keyword');
            const volumeSlider = document.getElementById("volumeSlider");

            // åˆæœŸè¨­å®š
            updateRepeatModeButton();

            // ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®è¡¨ç¤ºã¨èª¿æ•´
            if (!/iPad|iPhone|iPod/.test(navigator.userAgent) || window.MSStream) {
                volumeSlider.style.display = 'block';
            }
            volumeSlider.addEventListener("input", function() {
                audio.volume = volumeSlider.value;
            });

            // ãƒªãƒ”ãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            repeatModeButton.addEventListener('click', toggleRepeatMode);

            // Dropdown selection change handler
            playlistDropdown.addEventListener('change', function() {
                const selectedOption = playlistDropdown.value;
                switch (selectedOption) {
                    case 'searchPlaylist':
                        searchBox.style.display = 'flex';
                        keywordInput.placeholder = "ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆIDã‚’å…¥åŠ›...";
                        break;
                    case 'searchTrack':
                        searchBox.style.display = 'flex';
                        keywordInput.placeholder = "æ›²åã‹ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆåã‚’å…¥åŠ›...";
                        break;
                    case 'searchArtist':
                        searchBox.style.display = 'flex';
                        keywordInput.placeholder = "ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆåã‚’å…¥åŠ›...";
                        break;
                    default:
                        searchBox.style.display = 'none';
                        window.location.href = `/?playlist_id=${selectedOption}`;
                        break;
                }
            });

            // æ¤œç´¢æ©Ÿèƒ½
            function performSearch() {
                const keyword = keywordInput.value;
                if (!keyword) {
                    alert("Please enter a keyword.");
                    return; // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒç©ºã®å ´åˆã¯å‡¦ç†ã‚’ä¸­æ–­
                }

                /* ãƒ¢ãƒã‚¤ãƒ«ãƒ‡ãƒã‚¤ã‚¹ã‹PCã‹ã‚’åˆ¤å®š */
                function isMobileDevice() {
                    return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                }

                let apiEndpoint = '';

                if (playlistDropdown.value === 'searchTrack') {
                    window.location.href = `/?keyword=${encodeURIComponent(keyword)}`;
                } else if (playlistDropdown.value === 'searchPlaylist') {
                    window.location.href = `/?playlist_id=${encodeURIComponent(keyword)}`;
                } else if (playlistDropdown.value === 'searchArtist') {
                    apiEndpoint = `/search_artist?keyword=${encodeURIComponent(keyword)}`;

                    fetch(apiEndpoint)
                        .then(response => {
                            if (response.ok) {
                                return response.json();
                            }
                            throw new Error('Search failed: ' + response.statusText);
                        })
                        .then(data => {
                            if (data.artist_id) {
                                // ãƒ‡ãƒã‚¤ã‚¹ã‚¿ã‚¤ãƒ—ã«åŸºã¥ã„ã¦ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã¾ãŸã¯æ–°ã—ã„ã‚¿ãƒ–ã‚’é–‹ã
                                const artistUrl = `/artist/${data.artist_id}`;
                                if (isMobileDevice()) {
                                    window.location.href = artistUrl; // ãƒ¢ãƒã‚¤ãƒ«ã®å ´åˆã¯åŒã˜ã‚¿ãƒ–ã§é–‹ã
                                } else {
                                    window.open(artistUrl, '_blank'); // PCã®å ´åˆã¯æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã
                                }
                            }
                        })
                        .catch(error => {
                            console.error('Error searching artist:', error);
                        });
                }
            }

            searchButton.addEventListener('click', performSearch);
            keywordInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    performSearch();
                }
            });

            function setRepeatMode(mode) {
                repeatMode = mode;
                updateRepeatModeButton();

                // ãƒ¢ãƒ¼ãƒ‰å¤‰æ›´æ™‚ã«ãƒ­ã‚°ã‚’è¡¨ç¤º
                console.log(`Repeat mode set to: ${repeatMode}`);
            }

            function toggleRepeatMode() {
                if (repeatMode === 'all') {
                    setRepeatMode('single');
                } else {
                    setRepeatMode('all');
                }
            }

            function updateRepeatModeButton() {
                const repeatModeButton =
                             document.getElementById('repeatModeButton');
                const icon = repeatModeButton.querySelector('i');
                const text = repeatModeButton.querySelector('span');
                if (repeatMode === 'all') {
                    icon.className = 'fas fa-sync'; // å…¨æ›²
                    text.textContent = "all";
                } else {
                    icon.className = 'fas fa-redo'; // å˜æ›²
                    text.textContent = "1";
                }
            }
        });

        function sortTracks(sortType, sortOrder) {
            const params = new URLSearchParams(window.location.search); // ç¾åœ¨ã®URLã®ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å–å¾—
            params.set('sort', sortType); // ã‚½ãƒ¼ãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¨­å®šã¾ãŸã¯æ›´æ–°
            params.set('order', sortOrder); // ã‚½ãƒ¼ãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¨­å®šã¾ãŸã¯æ›´æ–°

            // ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆIDãŒURLã«ãªã„å ´åˆã€ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‹ã‚‰å–å¾—ã—ã¦è¨­å®š
            if (!params.has('playlist_id')) {
                const playlistId = document.getElementById('playlistDropdown').value;
                const searchOptions = ['searchTrack', 'searchArtist', 'searchPlaylist'];
                if (playlistId && !searchOptions.includes(playlistId)) {
                    params.set('playlist_id', playlistId);
                } else {
                    params.set('playlist_id', defaultPlaylistId); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆIDã‚’è¨­å®š
                }
            }

            const newUrl = `${window.location.pathname}?${params.toString()}`; // æ–°ã—ã„URLã‚’ç”Ÿæˆ
            window.location.href = newUrl; // æ–°ã—ã„URLã§ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰
        }

        function resetTracks() {
            const params = new URLSearchParams(window.location.search); // ç¾åœ¨ã®URLã‹ã‚‰ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å–å¾—

            // ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆIDãŒãªã„å ´åˆã¯ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            if (!params.has('playlist_id')) {
                params.set('playlist_id', `${defaultPlaylistId}`);
            }

            // ã‚½ãƒ¼ãƒˆé–¢é€£ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å‰Šé™¤
            params.delete('sort');
            params.delete('order');

            // ãƒªã‚»ãƒƒãƒˆå¾Œã®URLã§ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰
            const newUrl = `${window.location.pathname}?${params.toString()}`;
            window.location.href = newUrl;
        }

        function markPlayingItem(index) {
            // æ—¢å­˜ã®å†ç”Ÿä¸­ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å‰Šé™¤
            document.querySelectorAll('.custom-list-item').forEach(item => {
                item.classList.remove('playing-item');
            });

            // æŒ‡å®šã•ã‚ŒãŸã‚¢ã‚¤ãƒ†ãƒ ã«å†ç”Ÿä¸­ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¿½åŠ 
            const listItem = document.getElementsByClassName('custom-list-item')[index];
            if (listItem) {
                listItem.classList.add('playing-item');
            }
        }

        function openCamelotWheel() {
            const img = document.createElement('img');
            img.src = '/static/camelot_wheel.png';
            img.alt = 'Camelot Wheel';
            img.style = 'max-width: 80%; max-height: 80%;';

            const modal = document.createElement('div');
            modal.style = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); display: flex; justify-content: center; align-items: center;';
            modal.appendChild(img);

            document.body.appendChild(modal);

            modal.onclick = function() {
              document.body.removeChild(modal);
            };
        }
      </script>
    </div>
  </body>
</html>
